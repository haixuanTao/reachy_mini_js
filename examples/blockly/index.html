<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reachy Mini - Blockly Controller</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/10.4.3/blockly.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/acorn/8.11.3/acorn.min.js"></script>
</head>
<body>
  <header>
    <h1>ü§ñ Reachy Mini</h1>
    <div class="status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Disconnected</span>
    </div>
    <div class="controls">
      <button id="connectBtn" onclick="toggleConnection()">üîå Connect</button>
      <button onclick="checkMotors()">üîç Check</button>
      <button onclick="enableAllTorque()">‚ö° Torque On</button>
      <button onclick="disableAllTorque()">üí§ Torque Off</button>
      <button onclick="rebootAllMotors()">üîÑ Reboot All</button>
      <button class="primary" onclick="runCode()">‚ñ∂ Run</button>
      <button class="danger" onclick="stopCode()">‚¨õ Stop</button>
      <button onclick="saveWorkspace()">üíæ Save</button>
      <button onclick="loadWorkspace()">üìÇ Load</button>
    </div>
  </header>

  <main>
    <div id="blocklyDiv"></div>
    <div class="sidebar">
      <div class="sidebar-header">Motor Status</div>
      <div class="motor-status" id="motorStatus">
        <div class="motor-badge" id="motor11">M11<span>--</span></div>
        <div class="motor-badge" id="motor12">M12<span>--</span></div>
        <div class="motor-badge" id="motor13">M13<span>--</span></div>
        <div class="motor-badge" id="motor14">M14<span>--</span></div>
        <div class="motor-badge" id="motor15">M15<span>--</span></div>
        <div class="motor-badge" id="motor16">M16<span>--</span></div>
        <div class="motor-badge" id="motor17">M17<span>--</span></div>
        <div class="motor-badge" id="motor18">M18<span>--</span></div>
      </div>
      <div class="tabs">
        <div class="tab" onclick="switchTab('code')">Code</div>
        <div class="tab active" onclick="switchTab('console')">Console</div>
      </div>
      <div class="tab-content" id="codeTab">
        <div class="sidebar-header" style="display: flex; justify-content: space-between; align-items: center;">
          <span>Generated Code</span>
          <select id="languageSelect" style="background: #333; border: 1px solid #555; color: #ccc; padding: 2px 6px; font-size: 10px; border-radius: 3px;" onchange="updateCodeOutput()">
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
          </select>
        </div>
        <div class="code-output" id="codeOutput">// Drag blocks here...</div>
      </div>
      <div class="tab-content active" id="consoleTab">
        <div class="sidebar-header">Console Output</div>
        <div class="console-output" id="consoleOutput"></div>
      </div>

      <!-- AI Assistant Panel -->
      <div class="ai-assistant">
        <div class="ai-header">
          <div class="ai-header-title">
            <span>AI Assistant</span>
            <select id="aiProviderSelect" style="background: #333; border: 1px solid #555; color: #ccc; padding: 2px 6px; font-size: 10px; border-radius: 3px;">
              <option value="anthropic">Claude</option>
              <option value="openai">OpenAI</option>
              <option value="ollama">Ollama (Local)</option>
            </select>
          </div>
          <button class="ai-settings-btn" onclick="openAISettings()">Settings</button>
        </div>
        <div class="ai-chat" id="aiChat">
          <div class="ai-message system">Ask the AI to help edit your Blockly workspace</div>
        </div>
        <div class="ai-input-area">
          <input type="text" class="ai-input" id="aiInput" placeholder="Describe what you want to build..." onkeypress="if(event.key==='Enter')sendAIMessage()">
          <button class="ai-send-btn" id="aiSendBtn" onclick="sendAIMessage()">Send</button>
        </div>
      </div>
    </div>
  </main>

  <!-- AI Settings Modal -->
  <div class="ai-settings-modal" id="aiSettingsModal" onclick="if(event.target===this)closeAISettings()">
    <div class="ai-settings-content">
      <h3>AI Settings</h3>
      <div class="ai-settings-group">
        <label>Provider</label>
        <select id="settingsProvider" onchange="updateSettingsUI()">
          <option value="anthropic">Claude (Anthropic)</option>
          <option value="openai">OpenAI</option>
          <option value="ollama">Ollama (Local)</option>
        </select>
      </div>
      <div class="ai-settings-group" id="endpointGroup">
        <label>Endpoint URL</label>
        <input type="text" id="settingsEndpoint" placeholder="http://localhost:11434">
      </div>
      <div class="ai-settings-group" id="apiKeyGroup" style="display: none;">
        <label>API Key</label>
        <input type="password" id="settingsApiKey" placeholder="sk-...">
      </div>
      <div class="ai-settings-group">
        <label>Model</label>
        <input type="text" id="settingsModel" placeholder="llama3.2">
      </div>
      <div class="ai-settings-buttons">
        <button onclick="closeAISettings()">Cancel</button>
        <button class="primary" onclick="saveAISettings()">Save</button>
      </div>
    </div>
  </div>

  <!-- Comprehensive Toolbox -->
  <xml id="toolbox" style="display: none">
    <!-- Robot Connection -->
    <category name="üîå Connection" colour="260">
      <block type="enable_torque"></block>
      <block type="disable_torque"></block>
      <block type="enable_all"></block>
      <block type="disable_all"></block>
      <block type="check_joints"></block>
      <block type="ping_joint"></block>
      <block type="reboot_joint"></block>
      <block type="reboot_all"></block>
    </category>

    <!-- Antennas (Motors 17-18) -->
    <category name="üì° Antennas" colour="160">
      <block type="set_degrees">
        <value name="DEGREES"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
      </block>
      <block type="get_degrees"></block>
      <block type="move_by">
        <value name="AMOUNT"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
      </block>
    </category>

    <!-- Head (Motors 11-16) -->
    <category name="ü§ñ Head" colour="180">
      <block type="get_head_coordinates"></block>
      <block type="set_head_coordinates"></block>
    </category>

    <!-- Coordinates -->
    <category name="üìê Coordinates" colour="290">
      <block type="create_coordinates">
        <value name="X"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
        <value name="Y"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
        <value name="Z"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
        <value name="ROLL"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
        <value name="PITCH"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
        <value name="YAW"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
      </block>
      <block type="get_coordinate"></block>
    </category>

    <!-- Sensing -->
    <category name="üì° Sensing" colour="210">
      <block type="is_moving"></block>
      <block type="wait_until_stopped">
        <value name="TIMEOUT"><shadow type="math_number"><field name="NUM">5</field></shadow></value>
      </block>
      <block type="get_load"></block>
      <block type="get_temperature"></block>
      <block type="joint_in_range">
        <value name="MIN"><shadow type="math_number"><field name="NUM">-45</field></shadow></value>
        <value name="MAX"><shadow type="math_number"><field name="NUM">45</field></shadow></value>
      </block>
    </category>

    <!-- Timing -->
    <category name="‚è±Ô∏è Timing" colour="120">
      <block type="wait">
        <value name="TIME"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
      </block>
      <block type="wait_ms">
        <value name="TIME"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
      </block>
      <block type="get_time"></block>
      <block type="reset_timer"></block>
      <block type="timer_value"></block>
    </category>

    <!-- Output -->
    <category name="üìù Output" colour="60">
      <block type="log">
        <value name="MESSAGE"><shadow type="text"><field name="TEXT">Hello!</field></shadow></value>
      </block>
      <block type="log_joint"></block>
      <block type="log_type"></block>
      <block type="alert">
        <value name="MESSAGE"><shadow type="text"><field name="TEXT">Hello!</field></shadow></value>
      </block>
    </category>

    <sep></sep>

    <!-- Logic (Built-in) -->
    <category name="üîÄ Logic" colour="210">
      <block type="controls_if"></block>
      <block type="controls_if">
        <mutation else="1"></mutation>
      </block>
      <block type="controls_if">
        <mutation elseif="1" else="1"></mutation>
      </block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_ternary"></block>
    </category>

    <!-- Loops (Built-in) -->
    <category name="üîÅ Loops" colour="120">
      <block type="controls_repeat_ext">
        <value name="TIMES"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_for">
        <value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
        <value name="TO"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
        <value name="BY"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
      </block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>

    <!-- Math (Built-in) -->
    <category name="üî¢ Math" colour="230">
      <block type="math_number"><field name="NUM">0</field></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
      <block type="math_trig"></block>
      <block type="math_constant"></block>
      <block type="math_number_property"></block>
      <block type="math_round"></block>
      <block type="math_on_list"></block>
      <block type="math_modulo"></block>
      <block type="math_constrain">
        <value name="LOW"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
        <value name="HIGH"><shadow type="math_number"><field name="NUM">4095</field></shadow></value>
      </block>
      <block type="math_random_int">
        <value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
        <value name="TO"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
      </block>
      <block type="math_random_float"></block>
      <block type="math_atan2"></block>
    </category>

    <!-- Text (Built-in) -->
    <category name="üìÑ Text" colour="160">
      <block type="text"></block>
      <block type="text_join"></block>
      <block type="text_append">
        <value name="TEXT"><shadow type="text"></shadow></value>
      </block>
      <block type="text_length"></block>
      <block type="text_isEmpty"></block>
      <block type="text_indexOf"></block>
      <block type="text_charAt"></block>
      <block type="text_getSubstring"></block>
      <block type="text_changeCase"></block>
      <block type="text_trim"></block>
      <block type="text_prompt_ext">
        <value name="TEXT"><shadow type="text"><field name="TEXT">Enter value:</field></shadow></value>
      </block>
    </category>

    <!-- Lists (Built-in) -->
    <category name="üìã Lists" colour="260">
      <block type="lists_create_empty"></block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat">
        <value name="NUM"><shadow type="math_number"><field name="NUM">5</field></shadow></value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf"></block>
      <block type="lists_getIndex"></block>
      <block type="lists_setIndex"></block>
      <block type="lists_getSublist"></block>
      <block type="lists_split">
        <value name="DELIM"><shadow type="text"><field name="TEXT">,</field></shadow></value>
      </block>
      <block type="lists_sort"></block>
      <block type="lists_reverse"></block>
    </category>

    <!-- Variables (Built-in) -->
    <category name="üì¶ Variables" colour="330" custom="VARIABLE"></category>

    <!-- Functions (Built-in) -->
    <category name="üß© Functions" colour="290" custom="PROCEDURE"></category>
  </xml>

  <script type="module" src="index.js"></script>
  <script src="python-generator.js"></script>
  <script src="javascript-generator.js"></script>
  <script src="blockly-app.js"></script>
  <script src="ai-assistant.js"></script>
</body>
</html>
